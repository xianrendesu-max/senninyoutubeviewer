<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>仙人YouTubeビュアー</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;background:#f5f6f8;font-family:system-ui}
.banner{display:flex;gap:8px;padding:10px;background:#fff;position:sticky;top:0}
.banner button{flex:1;padding:10px;border-radius:10px;border:1px solid #ccc}
.banner button.active{background:#4f46e5;color:#fff}
iframe{width:100%;height:240px;border:none;background:#000}
.section{background:#fff;margin:12px;padding:12px;border-radius:12px}
</style>
</head>

<body>

<div class="banner">
  <button onclick="play('nocookie')">nocookie</button>
  <button onclick="play('embed')">invidious</button>
</div>

<iframe id="player"></iframe>

<div class="section">
  <h2 id="title">読み込み中...</h2>
  <button onclick="download()">⬇ ダウンロード</button>
  <p id="desc"></p>
</div>

<div class="section">
  <h3>インスタンス選択</h3>
  <select id="instanceSelect"></select>
</div>

<script>
const videoId = new URLSearchParams(location.search).get("v");
let currentInstance = "";

const player = document.getElementById("player");

function play(type){
  if(type==="nocookie"){
    player.src=`https://www.youtube-nocookie.com/embed/${videoId}`;
  }
  if(type==="embed"){
    player.src=`${currentInstance}/watch?v=${videoId}`;
  }
}

fetch(`/api/video?video_id=${videoId}`)
.then(r=>r.json())
.then(v=>{
  document.getElementById("title").textContent=v.title;
  document.getElementById("desc").textContent=v.description;
  currentInstance=v.instance;

  const sel=document.getElementById("instanceSelect");
  v.instances.forEach(i=>{
    const o=document.createElement("option");
    o.value=i;
    o.textContent=i;
    if(i===currentInstance) o.selected=true;
    sel.appendChild(o);
  });

  sel.onchange=()=>{
    currentInstance=sel.value;
    play("embed");
  };

  play("nocookie");
});

function download(){
  fetch(`/api/download?video_id=${videoId}`)
  .then(r=>r.json())
  .then(d=>{
    location.href = d.stream_url;
  });
}
</script>

</body>
</html>
