<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>仙人YouTubeビュアー</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { margin:0; background:#f5f6f8; font-family:system-ui; }
.banner {
  display:flex; gap:8px; padding:10px; background:#fff;
  position:sticky; top:0;
}
.banner button {
  flex:1; padding:10px; border-radius:10px; border:1px solid #ccc;
}
.banner button.active {
  background:#4f46e5; color:#fff;
}
iframe { width:100%; height:240px; border:none; background:#000; }
.section {
  background:#fff; margin:12px; padding:12px;
  border-radius:12px;
}
.download-btn {
  padding:10px 14px; border-radius:10px;
  background:#16a34a; color:#fff; border:none;
}
.comment { border-top:1px solid #eee; padding:8px 0; }
.author { font-weight:bold; }
</style>
</head>

<body>

<div class="banner">
  <button id="b1" onclick="play('nocookie')">nocookie</button>
  <button id="b2" onclick="play('embed')">embed</button>
  <button id="b3" onclick="play('education')">education</button>
</div>

<iframe id="player" allowfullscreen></iframe>

<div class="section">
  <h2 id="title">読み込み中...</h2>
  <button class="download-btn" onclick="loadDownload()">⬇ ダウンロード</button>
  <div id="downloadList"></div>
  <p id="desc"></p>
</div>

<div class="section">
  <h3>コメント</h3>
  <div id="comments">読み込み中...</div>
</div>

<div class="section">
  <h3>Invidious インスタンス</h3>
  <select id="instanceSelect"></select>
</div>

<script>
const videoId = new URLSearchParams(location.search).get("v");
const player = document.getElementById("player");
let currentInstance = "";

function setActive(id){
  document.querySelectorAll(".banner button").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function play(type){
  if(type==="nocookie"){
    player.src=`https://www.youtube-nocookie.com/embed/${videoId}`;
    setActive("b1");
  }
  if(type==="embed"){
    player.src=`${currentInstance}/embed/${videoId}`;
    setActive("b2");
  }
  if(type==="education"){
    player.src=`https://www.youtubeeducation.com/embed/${videoId}`;
    setActive("b3");
  }
}

fetch(`/api/video?video_id=${videoId}`)
.then(r=>r.json())
.then(v=>{
  document.getElementById("title").textContent=v.title;
  document.getElementById("desc").textContent=v.description;
  currentInstance=v.instance;
  const sel=document.getElementById("instanceSelect");
  v.instances.forEach(i=>{
    const o=document.createElement("option");
    o.value=i; o.textContent=i;
    if(i===currentInstance) o.selected=true;
    sel.appendChild(o);
  });
  sel.onchange=()=>{currentInstance=sel.value; play("embed");}
  play("nocookie");
});

fetch(`/api/comments?video_id=${videoId}`)
.then(r=>r.json())
.then(c=>{
  const d=document.getElementById("comments");
  d.innerHTML="";
  if(!c.comments.length){d.textContent="コメントなし";return;}
  c.comments.forEach(cm=>{
    const e=document.createElement("div");
    e.className="comment";
    e.innerHTML=`<div class="author"></div><div></div>`;
    e.children[0].textContent=cm.author;
    e.children[1].textContent=cm.content;
    d.appendChild(e);
  });
});

function loadDownload(){
  fetch(`/api/download?video_id=${videoId}`)
  .then(r=>r.json())
  .then(d=>{
    const l=document.getElementById("downloadList");
    l.innerHTML="";
    d.formats.forEach(f=>{
      const a=document.createElement("a");
      a.href=f.url; a.target="_blank";
      a.textContent=`${f.quality} (${f.type})`;
      l.appendChild(a);
    });
  });
}
</script>

</body>
</html>
